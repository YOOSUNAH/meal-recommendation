<!DOCTYPE html>
<html lang="ko">
<head>
    <title>OJM</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/script.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div class="flex min-h-[100dvh] flex-col items-center justify-center bg-background px-4 py-12 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-md text-center">
        <h1 class="text-4xl font-bold tracking-tight text-foreground">
            당신의 식사를 정해드려요
        </h1>
        <div>
            <p class="mt-4 text-muted-foreground">
                카테고리 : <span id="selectedCategories"></span>
            </p>
            <div id="recommend-section" class="hidden text-center">
                <button onclick="recommend()"
                        class="inline-flex h-10 items-center justify-center rounded-md bg-black px-8 text-sm font-medium text-white shadow transition-colors hover:bg-black/90 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50">
                    다시 추천받을래요
                </button>
            </div>
            <p id="info-empty-restaurant" class="hidden mt-4 text-muted-foreground">
                근처에 해당되는 음식점이 존재하지 않아요<br>
                카테고리를 재선택하거나, 위치를 다른 곳으로 이동해주세요!
            </p>
            <div id="searchResultArea">
                <div id="searchResults" class="grid grid-cols-1 gap-8 sm:grid-cols-3" style="display:block"></div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        displaySelectedCategories()
        recommend()
    })

    function displaySelectedCategories() {
        const selectedCategories = JSON.parse(sessionStorage.getItem('categories'))
        document.getElementById('selectedCategories').innerHTML = selectedCategories.map(c => displayCategoryText(c)).join(' ')

    }

    function showInfoNoticeEmpty() {
        document.getElementById('info-empty-restaurant').style.display = 'block';
    }

    function hideInfoNoticeEmpty() {
        document.getElementById('info-empty-restaurant').style.display = 'none';
    }

    function showInfoReRecommend() {
        document.getElementById('recommend-section').style.display = 'block';
    }

    function hideInfoReRecommend() {
        document.getElementById('info-empty-restaurant').style.display = 'none';
    }

    function recommend() {
        hideInfoNoticeEmpty()
        hideInfoReRecommend()

        var xhr = new XMLHttpRequest()
        var url = "/v1/ojm/nearbyRestaurant"
        var data = JSON.stringify({
            currentLat: sessionStorage.getItem('latitude'),
            currentLon: sessionStorage.getItem('longitude'),
            selectedCategories: JSON.parse(sessionStorage.getItem('categories')).map(it => displayCategoryText(it))
        })

        xhr.open("POST", url, true)
        xhr.setRequestHeader("Content-Type", "application/json")

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var data = JSON.parse(xhr.responseText)
                    var restaurants = data.data
                    if (restaurants.length === 0) {
                        showInfoNoticeEmpty()
                        return
                    }
                    var searchResultElements = ""
                    restaurants.forEach(restaurant => {
                        searchResultElements +=
                            "<div class=\"previousSearchItem bg-card p-4 rounded-lg shadow-md\">\n" +
                            "    <h3 class=\"text-lg font-medium\">음식점 : " + restaurant.name + "</h3>\n" +
                            "    <p class=\"mt-2 text-muted-foreground\">카테고리: " + restaurant.category + "</p>\n" +
                            "    <p class=\"mt-2 text-muted-foreground\">주소: " + restaurant.address + "</p>\n" +
                            "    <p class=\"mt-2 text-muted-foreground\">전화번호: " + (restaurant.number ? restaurant.number : '정보 없음') + "</p>\n" +
                            "</div>"
                    })
                    document.getElementById('searchResults').innerHTML = searchResultElements
                    showInfoReRecommend()
                } else {
                    if (xhr.status === 404) {
                        showInfoNoticeEmpty()
                    } else {
                        console.error("Error occurred: " + xhr.statusText)
                    }
                }
            }
        }

        xhr.send(data)
    }

    function displayCategoryText(categoryType){
        if(categoryType === 'Korean'){
            return '한식'
        }
        if(categoryType === 'Japanese'){
            return '일식'
        }
        if(categoryType === 'Chinese'){
            return '중식'
        }
        if(categoryType === 'Western'){
            return '양식'
        }
        return '기타'
    }
</script>
</body>
</html>
